# EDM BiFlowNet diffusion model training configuration

# Data
latents_zarr: zarrs/encoded-latents-attention-sweep-3.zarr
# latents_zarr: /scratch/dhruman_gupta/noddyverse_preprocessed/output-latents.zarr
num_workers: 8
pad_to: 24
no_logvar: true

# Optional latent filtering/weighting
# - type: density_weighting -> keep all samples, use per-sample loss weights
# - type: weighted_filtering -> sample indices from density weights and use unit weights
latent_weighing:
  enabled: false
  type: density_weighting
  mode: cache_only
  cache_path: null
  proj_dim: 4096
  proj_seed: 0
  k: 30
  alpha: 1.5
  w_min: 0.02
  w_max: 5.0
  distance: cosine
  normalize_embeddings: true
  index_factory: IVF16384,PQ64x8
  nprobe: 64
  train_size: 200000
  search_extra: 8
  use_gpu: true
  faiss_num_gpus: 0
  projection_backend: torch_countsketch
  projection_device: null
  projection_feature_chunk: 16384
  verbose: true
  # weighted_filtering-only:
  # num_samples: 1000000
  # sampling_seed: 0
  # replacement: true

# Stats (latent normalization)
stats_path: cache/vae-sweep-3-latent_stats.json  # auto-generates in output_dir if null
recompute_stats: false
stats_batch_size: 64
use_single_vae_scaling: false # If true, use global std across channels instead of per-channel

# Model (BiFlowNet)
model_dim: 32
dim_mults: [1, 1, 2, 4]
use_attn: [0, 0, 1, 1]
patch_size: 1
sub_volume_size: 4
vq_size: 32
num_mid_dit: 1
attn_heads: 4
dit_num_heads: 4
resnet_groups: 16
mlp_ratio: 3.0
init_kernel_size: 3

# EDM-specific parameters
sigma_data: 1.0
sigma_min: 0.002
sigma_max: 20.0
rho: 7.0
P_mean: -0.6
P_std: 1.2

# Training
batch_size: 128
lr: 5.0e-5
grad_clip: 1.0
seed: 42
gradient_accumulation_steps: 1
warmup_samples: 150000
max_steps: 5000000

# Evaluation
eval_every_steps: 250000
num_eval_samples: 1
num_eval_steps: 64
decode_batch_size: 1

# Decode (VAE)
vae_checkpoint: outputs/vae_attention_sweep_3/latent_channels_4/kl_weight_0.001/vae_attention_checkpoint_step_1000008.pt
vae_stats_path: cache/vae_stats.json  # optional override; uses checkpoint stats_path if null
data_original_size: null  # center-crop decoded volumes to this size (set null to disable)
save_decoded_samples: true
num_save_samples: 1
decoded_dtype: float32

# Output
output_dir: outputs/edm_biflownet_attention_sweep_3_latents_overfit_10
run_name: edm_biflownet_attention_sweep_3_latents_overfit_10
save_every: 250000
log_every: 4096
progress: false
